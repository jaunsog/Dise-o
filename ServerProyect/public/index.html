<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
</head>


<body>
	<h1>TioRicoSAS</h1>
	<h3 class="Title">Seleccione su rango de interés para trazar una ruta histórica:</h3>
	<p class="subtitulo" id="subtitulo">Valores de última posición:</p>
	<p class="latitude" id="latitude">Latitud:</p>
	<p class="longitude" id="longitude">Longitud:</p>
	<p class="timestep" id="time">Tiempo:</p>

	<button class="boton" onclick="Centrado()"></button>
	<button class="boton1" onclick="trazar()">Trazar Historico (línea roja)</button>
	<button class="boton2" onclick="limpiar()">No mostrar Historico</button>
	<div id="map">
	</div>
	<form>

		<label class="date1"> Comienzo:</label>
		<input class="date11" id="date01" type="datetime-local" pattern="yyyy-MM-dd-HH:mm:ss" /><br>
	</form>
	<form>

		<label class="date2"> Final:</label>
		<input class="date22" id="date02" type="datetime-local" /><br>
	</form>
	<style>
		.Title {
			position: absolute;
			opacity: 0.8;
			top: 26rem;
			left: 1rem;
			color: #FFFFFF;
			z-index: 10;
			margin: 0;
			padding: 0;
			height: 20vh;
			width: 20vw;
		}

		.date2 {
			position: absolute;
			opacity: 0.8;
			top: 33rem;
			left: 1rem;
			color: #FFFFFF;
			z-index: 10;
			margin: 0;
			padding: 0;
			height: 8vh;
			width: 12vw;
		}

		.date22 {
			position: absolute;
			opacity: 0.6;
			top: 34rem;
			left: 1rem;
			color: #000000;
			z-index: 10;
			margin: 0;
			padding: 0;
		}

		.date1 {
			position: absolute;
			opacity: 0.8;
			top: 30rem;
			left: 1rem;
			color: #FFFFFF;
			z-index: 10;
			margin: 0;
			padding: 0;
			height: 8vh;
			width: 12vw;
		}

		.date11 {
			position: absolute;
			opacity: 0.6;
			top: 31rem;
			left: 1rem;
			color: #000000;
			z-index: 10;
			margin: 0;
			padding: 0;
		}

		.boton1 {

			position: absolute;
			opacity: 0.8;
			top: 36rem;
			left: 1rem;
			color: #000000;
			z-index: 10;
			margin: 0;
			padding: 0;
			height: 6vh;
			width: 18vw;

		}

		.boton2 {

			position: absolute;
			opacity: 0.8;
			top: 36rem;
			left: 17rem;
			color: #000000;
			z-index: 10;
			margin: 0;
			padding: 0;
			height: 6vh;
			width: 18vw;

		}

		.boton {

			position: absolute;
			background-image:url(icon.ico);
			background-repeat:no-repeat;
			opacity: 0.8;
			top: 12rem;
			left: 1rem;
			z-index: 10;
			height: 36px;
			width: 36px;

		}

		h2 {
			position: absolute;
			top: 20rem;
			left: 1rem;
			color: #e9f2eb;
			z-index: 10;
			margin: 0;
			padding: 0;
		}

		p {

			position: absolute;
			top: 9rem;
			left: 1rem;
			color: #e9f2eb;
			z-index: 10;
			margin: 0;
			padding: 0;
		}

		.subtitulo {
			top: 6rem;
		}

		.latitude {
			top: 8rem;
		}

		.longitude {
			top: 9rem;
		}

		.timestep {
			top: 10rem;
		}

		h1 {
			position: absolute;
			top: 3rem;
			left: 1rem;
			color: #e9f2eb;
			z-index: 20;
			margin: 0;
			padding: 10;
		}

		#map {
			position: absolute;
			top: 0;
			left: 0;
			height: 100% !important;
			width: 100% !important;

		}
	</style>

	<script>
		var map;
		var markers = [];
		var centrar = [];
		var polylinePlanCoordinates = [];
		var path1;
		var x = 0;
		var i;
		var o = 0;
		var polylineLive = [];



		function iniciarMap() {
			let str;
			var coord1 = { lat: 10.972291426090106, lng: -74.40225011664694 };
			let latitud;
			let longitud;
			let time;
			var image = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Delivery-truck.svg/512px-Delivery-truck.svg.png"


			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 11,
				center: coord1
			});
			marker = new google.maps.Marker({
				map: map,

			});
			pathLive = new google.maps.Polyline({
				path: polylineLive,
				geodesic: true,
				strokeColor: '#0095b6',
				strokeOpacity: 1.0,
				strokeWeight: 2
			});
			pathLive.setMap(map);
			markers.push(marker);
			movimiento();
		}

		async function Centrado() {
			try {
				const ubic = await refresh();
				const coord = { lat: ubic.latitude, lng: ubic.longitude };
				map.setCenter(coord);
			} catch (error) { }
		}

		async function refresh() {
			const response = await fetch('/ruta', { method: 'GET' });
			const jsons = await response.json();
			console.log(jsons);
			return jsons;
		}
		async function movimiento() {
			try {
				const ubic = await refresh();
				const coord = { lat: ubic.latitude, lng: ubic.longitude };
				const i = 0;
				texto(ubic);
				markers[0].setPosition(coord);

				const path = pathLive.getPath();
				path.push(markers[0].getPosition());
				path.setMap(null);
				path.setMap(map);


			} catch (error) { }

			setTimeout(movimiento, 3000);
		}

		async function texto(ubic) {
			document.getElementById('latitude').innerHTML = "Latitud: "+ubic.latitude;
			document.getElementById('longitude').innerHTML = "Longitud: "+ubic.longitude;

			timestamp= ' Fecha:'+ubic.año+'-'+ubic.mes+'-'+ubic.dia+'. Hora:'+ubic.hora+'-'+ubic.minuto+".";
			document.getElementById("time").innerHTML = "Tiempo: "+timestamp;


		}
		refresh();

		async function trazar() {
			if (o==1){
				path1.setMap(null);
			}
			var d1 = document.getElementById("date01").value;
			d11 = d1.toString().split('-');
			var d1array = [];
			d1array[0] = d11[0];
			d1array[1] = d11[1];
			d111 = d11[2].split('T');
			d1array[2] = d111[0];
			d1111 = d111[1].split(':');
			d1array[3] = d1111[0];
			d1array[4] = d1111[1];
			
			var d2 = document.getElementById("date02").value;
			d22 = d2.toString().split('-');
			var d2array = [];
			d2array[0] = d22[0];
			d2array[1] = d22[1];
			d222 = d22[2].split('T');
			d2array[2] = d222[0];
			d2222 = d222[1].split(':');
			d2array[3] = d2222[0];
			d2array[4] = d2222[1];
			
			var totald1 = d1array[0] + '' + d1array[1] + '' + d1array[2] + '' + d1array[3] + '' + d1array[4];
			var totald2 = d2array[0] + '' + d2array[1] + '' + d2array[2] + '' + d2array[3] + '' + d2array[4];
			console.log(parseInt(totald1));
			console.log(totald2);
			polylinePlanCoordinates = [];
			const response = await fetch('/baseDeDatos', { method: 'GET' });
			const data = await response.json();
			data.forEach((object) =>{
				var totalobject = object.año + '' + object.mes + '' + object.dia + '' + object.hora + '' + object.minuto;
				if ((parseInt(totalobject) >= parseInt(totald1)) && (parseInt(totalobject) <= parseInt(totald2))) {
					polylinePlanCoordinates.push({ lat: parseFloat(object.latitude), lng: parseFloat(object.longitude) });
				}
			});
			path1 = new google.maps.Polyline({
				path: polylinePlanCoordinates,
				geodesic: true,
				strokeColor: '#FF0000',
				strokeOpacity: 1.0,
				strokeWeight: 2
			});
			console.log(polylinePlanCoordinates);
			path1.setMap(map);
			o=1;
		}



		function limpiar() {
			path1.setMap(null);
		}

	</script>
	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEul9Esi6UslpNJ_gHAZh_S3CMvlY6vzM&callback=iniciarMap"></script>

</body>

</html>